# –ú–æ–¥—É–ª—å 19. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (iSCSI)

[‚Üê –ù–∞–∑–∞–¥ –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é](../README.md)

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

* [–û–ø–∏—Å–∞–Ω–∏–µ](#–æ–ø–∏—Å–∞–Ω–∏–µ)
* [–ß–∞—Å—Ç—å 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iSCSI Target (srv2-cod)](#—á–∞—Å—Ç—å-1-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-iscsi-target-srv2-cod)
* [–ß–∞—Å—Ç—å 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iSCSI Initiator (srv1-cod)](#—á–∞—Å—Ç—å-2-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-iscsi-initiator-srv1-cod)
* [–ü—Ä–æ–≤–µ—Ä–∫–∞](#–ø—Ä–æ–≤–µ—Ä–∫–∞)

---

## –û–ø–∏—Å–∞–Ω–∏–µ

–í –¥–∞–Ω–Ω–æ–º –º–æ–¥—É–ª–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è iSCSI-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ: —Å–µ—Ä–≤–µ—Ä **srv2-cod** –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ Target (–ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∏—Å–∫), –∞ **srv1-cod** ‚Äî –≤ —Ä–æ–ª–∏ Initiator (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç –¥–∏—Å–∫ –ø–æ —Å–µ—Ç–∏).

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- |
| iSCSI Target | srv2-cod (192.168.20.2) |
| iSCSI Initiator | srv1-cod |
| IQN | iqn.2026-11.region.ssa2026.cod:data.target |
| –î–∏—Å–∫ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ | /dev/sda (5 –ì–ë) |
| –ü–æ—Ä—Ç iSCSI | 3260 |

**–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:**
```
srv1-cod (Initiator)  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄiSCSI‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫  srv2-cod (Target)
     ‚îÇ                                         ‚îÇ
     ‚îÇ                                    /dev/sda (5GB)
     ‚ñº                                         
   /dev/sdb (5GB)
```

---

## –ß–∞—Å—Ç—å 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iSCSI Target (srv2-cod)

### srv2-cod (alt-server)

#### –®–∞–≥ 1.1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤

```bash
apt-get update && apt-get install -y scsitarget-utils
```

#### –®–∞–≥ 1.2: –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã tgt

```bash
systemctl enable --now tgt
```

#### –®–∞–≥ 1.3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏—Å–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –±–ª–æ—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤:

```bash
lsblk
```

![–°–ø–∏—Å–æ–∫ –±–ª–æ—á–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ Target](../images/iscsi-lsblk-target.png)

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏—Å–∫ `/dev/sda` —Ä–∞–∑–º–µ—Ä–æ–º 5 –ì–ë. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏—Å–∫ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!

#### –®–∞–≥ 1.4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∏—Å–∫–∞

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/tgt/targets.conf`:

```bash
nano /etc/tgt/targets.conf
```

–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞:

```xml
<target iqn.2026-11.region.ssa2026.cod:data.target>
    direct-store /dev/sda
</target>
```

![–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è targets.conf](../images/iscsi-targets-conf.png)

**–§–æ—Ä–º–∞—Ç IQN:**
```
iqn.<–≥–æ–¥>-<–º–µ—Å—è—Ü>.<–¥–æ–º–µ–Ω –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ>:<–∏–º—è —Ä–µ—Å—É—Ä—Å–∞>
```

#### –®–∞–≥ 1.5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã tgt

```bash
systemctl restart tgt
```

#### –®–∞–≥ 1.6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Target

```bash
tgtadm --lld iscsi --op show --mode target
```

![–ü—Ä–æ–≤–µ—Ä–∫–∞ iSCSI Target](../images/iscsi-tgtadm-show.png)

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
* Target 1: `iqn.2026-11.region.ssa2026.cod:data.target`
* State: `ready`
* LUN 1: Size: `5369 MB`, Backing store path: `/dev/sda`

#### –®–∞–≥ 1.7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ LVM

–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–∫–ª—é—á–∏—Ç—å iSCSI-–¥–∏—Å–∫–∏ –∏–∑ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è LVM.

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `/etc/lvm/lvm.conf`:

```bash
nano /etc/lvm/lvm.conf
```

–í –±–ª–æ–∫–µ `devices` –Ω–∞–π–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `filter` –∏ –∏–∑–º–µ–Ω–∏—Ç–µ –µ–≥–æ:

```
filter = [ "r|/dev/sd|" ]
```

![–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ LVM](../images/iscsi-lvm-filter.png)

> ‚ÑπÔ∏è **–ü–æ—è—Å–Ω–µ–Ω–∏–µ:** –§–∏–ª—å—Ç—Ä `r|/dev/sd|` –∑–∞–ø—Ä–µ—â–∞–µ—Ç LVM —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ `/dev/sd*`, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å iSCSI-–¥–∏—Å–∫–∞–º–∏.

---

## –ß–∞—Å—Ç—å 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iSCSI Initiator (srv1-cod)

### srv1-cod (alt-server)

> ‚ÑπÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è —Ä–∞–±–æ—Ç—ã iSCSI Initiator –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–∏—Å–∫ –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ srv1-cod –≤ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä–µ.

![–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∏—Å–∫–∞ –≤ Proxmox](../images/iscsi-proxmox-disk.png)

#### –®–∞–≥ 2.1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤

```bash
apt-get update && apt-get install -y open-iscsi
```

#### –®–∞–≥ 2.2: –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã iscsid

```bash
systemctl enable --now iscsid
```

#### –®–∞–≥ 2.3: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ Target

–í—ã–ø–æ–ª–Ω–∏—Ç–µ discovery –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö Target:

```bash
iscsiadm -m discovery -t sendtargets -p 192.168.20.2
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
192.168.20.2:3260,1 iqn.2026-11.region.ssa2026.cod:data.target
```

#### –®–∞–≥ 2.4: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Target

```bash
iscsiadm -m node --login
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Logging in to [iface: default, target: iqn.2026-11.region.ssa2026.cod:data.target, portal: 192.168.20.2,3260]
Login to [iface: default, target: iqn.2026-11.region.ssa2026.cod:data.target, portal: 192.168.20.2,3260] successful.
```

#### –®–∞–≥ 2.5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `/etc/iscsi/iscsid.conf`:

```bash
nano /etc/iscsi/iscsid.conf
```

–í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
* –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ: `#node.startup = manual`
* –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ: `node.startup = automatic`

![–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ iSCSI](../images/iscsi-node-startup.png)

#### –®–∞–≥ 2.6: –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è:

```bash
nano /var/lib/iscsi/send_targets/192.168.20.2,3260/st_config
```

–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä:

```
discovery.sendtargets.use_discoveryd = Yes
```

![–ù–∞—Å—Ç—Ä–æ–π–∫–∞ discoveryd](../images/iscsi-discoveryd.png)

#### –®–∞–≥ 2.7: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:

```bash
reboot
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞

### srv1-cod (alt-server)

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ iSCSI-–¥–∏—Å–∫–∞:

```bash
lsblk
```

![–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –¥–∏—Å–∫–∞](../images/iscsi-lsblk-initiator.png)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
* `sda` ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–∏—Å–∫ 20 –ì–ë (—Å–∏—Å—Ç–µ–º–Ω—ã–π)
* `sdb` ‚Äî iSCSI-–¥–∏—Å–∫ 5 –ì–ë (–ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π —Å srv2-cod)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π:**
```bash
iscsiadm -m session
```

**–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:**
```bash
iscsiadm -m session -P 3
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª—É–∂–±—ã:**
```bash
systemctl status iscsid
```

---

## üìÅ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –•–æ—Å—Ç | –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- | --- |
| srv2-cod | `/etc/tgt/targets.conf` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è iSCSI Target |
| srv2-cod | `/etc/lvm/lvm.conf` | –§–∏–ª—å—Ç—Ä LVM |
| srv1-cod | `/etc/iscsi/iscsid.conf` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è iSCSI Initiator |
| srv1-cod | `/var/lib/iscsi/send_targets/*/st_config` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ discovery |

---

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
| --- | --- | --- |
| `connection refused` | –°–ª—É–∂–±–∞ tgt –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ | `systemctl start tgt` |
| `no portals found` | –ù–µ–≤–µ—Ä–Ω—ã–π IP Target | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP-–∞–¥—Ä–µ—Å srv2-cod |
| `login failed` | Target –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `/etc/tgt/targets.conf` |
| –î–∏—Å–∫ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ reboot | –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `node.startup = automatic` |
| LVM –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã | –§–∏–ª—å—Ç—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω | –î–æ–±–∞–≤—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä –≤ `/etc/lvm/lvm.conf` |

---

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

**iSCSI Target (srv2-cod):**
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ Target
tgtadm --lld iscsi --op show --mode target

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã
systemctl restart tgt
```

**iSCSI Initiator (srv1-cod):**
```bash
# –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ Target
iscsiadm -m discovery -t sendtargets -p <IP>

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
iscsiadm -m node --login

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
iscsiadm -m node --logout

# –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
iscsiadm -m session
```

---

[‚Üê –ù–∞–∑–∞–¥ –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é](../README.md)
